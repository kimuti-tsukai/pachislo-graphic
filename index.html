<!doctype html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Matter.js - è½ä¸‹ã™ã‚‹çƒã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</title>
        <style>
            body {
                margin: 0;
                padding: 20px;
                font-family: Arial, sans-serif;
                background-color: #1a1a1a;
                color: white;
            }

            #canvas-container {
                display: flex;
                justify-content: center;
                margin: 20px 0;
            }

            canvas {
                border: 2px solid #444;
                background-color: #2a2a2a;
            }

            .controls {
                text-align: center;
                margin: 20px 0;
            }

            button {
                background-color: #4a90e2;
                color: white;
                border: none;
                padding: 10px 20px;
                margin: 0 10px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 16px;
            }

            button:hover {
                background-color: #357abd;
            }

            .info {
                text-align: center;
                margin: 10px 0;
                font-size: 14px;
                color: #ccc;
            }
        </style>
    </head>
    <body>
        <h1>Matter.js - è½ä¸‹ã™ã‚‹çƒã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h1>
        <div class="info">
            å¤§ããªçƒãŒå°ã•ãªå›ºå®šçƒã®é–“ã‚’è½ä¸‹ã—ã¾ã™ã€‚<br />
            <strong style="color: #2ecc71">ç·‘ã®ã‚¨ãƒªã‚¢</strong
            >ã‚’é€šéã™ã‚‹ã¨ã€Œã‚ãŸã‚Šã€ã€<strong style="color: #e74c3c"
                >èµ¤ã®ã‚¨ãƒªã‚¢</strong
            >ã‚’é€šéã—ã¦ã‚‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ã•ã‚Œã¾ã›ã‚“ã€‚
        </div>

        <div id="canvas-container">
            <canvas id="canvas"></canvas>
        </div>

        <div class="controls">
            <button onclick="dropBall()">çƒã‚’è½ã¨ã™</button>
            <button onclick="resetSimulation()">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>

        <div class="info">
            F12ã‚­ãƒ¼ã‚’æŠ¼ã—ã¦ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’é–‹ãã€çƒãŒåº•éƒ¨ã‚’é€šéã™ã‚‹æ§˜å­ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.18.0/matter.min.js"></script>
        <script>
            // Matter.jsã®ä¸»è¦ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å–å¾—
            const {
                Engine,
                Render,
                Runner,
                Bodies,
                Composite,
                Events,
                Mouse,
                MouseConstraint,
            } = Matter;

            // ã‚¨ãƒ³ã‚¸ãƒ³ã‚’ä½œæˆ
            const engine = Engine.create();
            const world = engine.world;

            // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã‚’ä½œæˆ
            const canvas = document.getElementById("canvas");
            const render = Render.create({
                canvas: canvas,
                engine: engine,
                options: {
                    width: 800,
                    height: 600,
                    wireframes: false,
                    background: "transparent",
                    showAngleIndicator: true,
                    showVelocity: false,
                },
            });

            // é‡åŠ›ã‚’è¨­å®š
            engine.world.gravity.y = 3.0;

            // å£ã‚’ä½œæˆ
            const walls = [
                // å·¦ã®å£
                Bodies.rectangle(0, 300, 50, 600, {
                    isStatic: true,
                    render: { fillStyle: "#444" },
                }),
                // å³ã®å£
                Bodies.rectangle(800, 300, 50, 600, {
                    isStatic: true,
                    render: { fillStyle: "#444" },
                }),
            ];

            // é‡˜ã‚’å®Œå…¨ã«ãƒ©ãƒ³ãƒ€ãƒ ã«ç”Ÿæˆ
            const nails = [];
            const nailRadius = 4; // é‡˜ã‚’ä¸Šã‹ã‚‰è¦‹ãŸæ™‚ãã‚‰ã„ã®å°ã•ã„ã‚µã‚¤ã‚º
            const nailCount = 80; // é‡˜ã®æ•°

            for (let i = 0; i < nailCount; i++) {
                // å®Œå…¨ã«ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã‚’ç”Ÿæˆ
                const x = 80 + Math.random() * 640; // å·¦å³ã®å£ã‹ã‚‰80pxé›¢ã‚ŒãŸç¯„å›²
                const y = 120 + Math.random() * 380; // ä¸Šéƒ¨ã¨åº•éƒ¨ã‚¨ãƒªã‚¢ã‚’é¿ã‘ãŸç¯„å›²

                const nail = Bodies.circle(x, y, nailRadius, {
                    isStatic: true,
                    render: {
                        fillStyle: "#e74c3c",
                        strokeStyle: "#c0392b",
                        lineWidth: 1,
                    },
                });
                nails.push(nail);
            }

            // åº•éƒ¨ã®ã€Œã‚ãŸã‚Šã€ã‚¨ãƒªã‚¢ã‚’ä½œæˆï¼ˆè¦–èªæ€§ã®è‰¯ã„ç·‘è‰²ï¼‰
            const winZone = Bodies.rectangle(400, 570, 200, 40, {
                isSensor: true,
                isStatic: true,
                render: {
                    fillStyle: "#2ecc71", // æ˜ã‚‹ã„ç·‘è‰²
                    strokeStyle: "#27ae60", // æ¿ƒã„ç·‘ã®ç¸
                    lineWidth: 3,
                    opacity: 0.8,
                },
            });

            // åº•éƒ¨ã®é€šå¸¸ã‚¨ãƒªã‚¢ï¼ˆã‚ãŸã‚Šã§ãªã„å ´æ‰€ï¼‰
            const normalZone = Bodies.rectangle(400, 570, 600, 40, {
                isSensor: true,
                isStatic: true,
                render: {
                    fillStyle: "#e74c3c", // èµ¤è‰²
                    strokeStyle: "#c0392b", // æ¿ƒã„èµ¤ã®ç¸
                    lineWidth: 2,
                    opacity: 0.5,
                },
            });

            // è½ä¸‹ã™ã‚‹å¤§ããªçƒã‚’æ ¼ç´ã™ã‚‹é…åˆ—
            let fallingBalls = [];

            // çƒã‚’è½ã¨ã™é–¢æ•°
            function dropBall() {
                const bigBall = Bodies.circle(
                    200 + Math.random() * 400, // ãƒ©ãƒ³ãƒ€ãƒ ãªXä½ç½®
                    50, // ä¸Šéƒ¨ã‹ã‚‰è½ä¸‹
                    12, // åŠå¾„ï¼ˆå…ƒã®åŠåˆ†ã®ã‚µã‚¤ã‚ºï¼‰
                    {
                        render: {
                            fillStyle: "#3498db",
                            strokeStyle: "#2980b9",
                            lineWidth: 3,
                        },
                        restitution: 0.6, // å¼¾æ€§
                        friction: 0.3,
                    },
                );

                fallingBalls.push(bigBall);
                Composite.add(world, bigBall);

                console.log(`æ–°ã—ã„çƒã‚’è½ä¸‹é–‹å§‹ (ID: ${bigBall.id})`);
            }

            // è¡çªæ¤œçŸ¥ã‚¤ãƒ™ãƒ³ãƒˆ - ã‚ãŸã‚Šã‚¨ãƒªã‚¢ã®ã¿ã§åå¿œ
            Events.on(engine, "collisionStart", function (event) {
                const pairs = event.pairs;

                pairs.forEach((pair) => {
                    const { bodyA, bodyB } = pair;

                    // ã‚ãŸã‚Šã‚¨ãƒªã‚¢ï¼ˆç·‘ã®éƒ¨åˆ†ï¼‰ã¨ã®è¡çªã‚’ãƒã‚§ãƒƒã‚¯
                    if (bodyA === winZone || bodyB === winZone) {
                        const ball = bodyA === winZone ? bodyB : bodyA;

                        // è½ä¸‹ã™ã‚‹çƒã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
                        if (fallingBalls.includes(ball)) {
                            console.log(
                                `ğŸ‰ ã‚ãŸã‚Šï¼çƒãŒå½“ãŸã‚Šã‚¨ãƒªã‚¢ã‚’é€šéã—ã¾ã—ãŸï¼ (Ball ID: ${ball.id}, ä½ç½®: x=${Math.round(ball.position.x)}, y=${Math.round(ball.position.y)})`,
                            );

                            // é€šéã—ãŸçƒã¯é…åˆ—ã‹ã‚‰å‰Šé™¤ï¼ˆé‡è¤‡é€šçŸ¥ã‚’é˜²ãï¼‰
                            const index = fallingBalls.indexOf(ball);
                            if (index > -1) {
                                fallingBalls.splice(index, 1);
                            }
                        }
                    }
                });
            });

            // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹é–¢æ•°
            function resetSimulation() {
                // å…¨ã¦ã®è½ä¸‹çƒã‚’å‰Šé™¤
                fallingBalls.forEach((ball) => {
                    Composite.remove(world, ball);
                });
                fallingBalls = [];
                console.log("ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
            }

            // ãƒã‚¦ã‚¹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’è¿½åŠ 
            const mouse = Mouse.create(render.canvas);
            const mouseConstraint = MouseConstraint.create(engine, {
                mouse: mouse,
                constraint: {
                    stiffness: 0.2,
                    render: {
                        visible: false,
                    },
                },
            });

            // ä¸–ç•Œã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ 
            Composite.add(world, [
                ...walls,
                ...nails, // é‡˜ã‚’è¿½åŠ 
                normalZone, // é€šå¸¸ã‚¨ãƒªã‚¢ï¼ˆèµ¤ï¼‰ã‚’å…ˆã«è¿½åŠ 
                winZone, // ã‚ãŸã‚Šã‚¨ãƒªã‚¢ï¼ˆç·‘ï¼‰ã‚’å¾Œã«è¿½åŠ ï¼ˆä¸Šã«è¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
                mouseConstraint,
            ]);

            // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã¨ã‚¨ãƒ³ã‚¸ãƒ³ã‚’é–‹å§‹
            Render.run(render);
            const runner = Runner.create();
            Runner.run(runner, engine);

            // åˆæœŸã®çƒã‚’1å€‹è½ã¨ã™
            setTimeout(() => {
                dropBall();
            }, 1000);

            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
            console.log("ğŸš€ Matter.js ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹");
            console.log(`é‡˜ã®æ•°: ${nails.length}`);
            console.log(
                "ã€Œçƒã‚’è½ã¨ã™ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã‹ã€ãƒã‚¦ã‚¹ã§çƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦éŠã¹ã¾ã™",
            );
            console.log("ç·‘ã®ã‚¨ãƒªã‚¢ã«çƒãŒå…¥ã‚‹ã¨ã€Œã‚ãŸã‚Šã€ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ï¼");
        </script>
    </body>
</html>
